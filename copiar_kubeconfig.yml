---
- name: ğŸ“ Copiar arquivo kubeconfig do Control Plane para o Servidor Ansible
  hosts: kubernetes_master
  gather_facts: false
  become: true # Aplica become: true aos hosts remotos (kubernetes_master) para acessar /etc/kubernetes/admin.conf

  tasks:
    - name: 1. Criar o diretÃ³rio .kube no servidor Ansible (localmente)
      file:
        path: "{{ lookup('env', 'HOME') }}/.kube"
        state: directory
        mode: "0700"
      delegate_to: localhost
      become: false # <--- CORREÃ‡ÃƒO: Desabilita a elevaÃ§Ã£o de privilÃ©gio (sudo) para esta tarefa local.
      # O diretÃ³rio serÃ¡ criado no HOME do usuÃ¡rio que executa o Ansible.

    - name: 2. Validar se o arquivo admin.conf existe no Master
      stat:
        path: /etc/kubernetes/admin.conf
      register: kubeconfig_file
      # Herda become: true do Play para poder acessar o diretÃ³rio /etc/kubernetes

    - name: 3. Copiar o admin.conf para o servidor Ansible (como ~/.kube/config)
      fetch:
        src: /etc/kubernetes/admin.conf
        dest: "{{ lookup('env', 'HOME') }}/.kube/config"
        flat: yes
        fail_on_missing: true
      when: kubeconfig_file.stat.exists
      # Herda become: true do Play para poder ler o arquivo root /etc/kubernetes/admin.conf

    - name: 4. Ajustar permissÃµes do arquivo kubeconfig no servidor Ansible
      file:
        path: "{{ lookup('env', 'HOME') }}/.kube/config"
        mode: "0600"
      delegate_to: localhost
      become: false # <--- CORREÃ‡ÃƒO: Desabilita a elevaÃ§Ã£o de privilÃ©gio (sudo) para esta tarefa local.
